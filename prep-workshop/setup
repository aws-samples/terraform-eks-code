# Dont put in latest version of flux cli - clashes with EKS workshop
#echo "Install flux"
#curl -s https://fluxcd.io/install.sh | sudo bash
#sudo curl -s https://fluxcd.io/install.sh | sudo FLUX_VERSION=2.1.0 bash
sudo yum install -y yum-utils shadow-utils
sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo
sudo yum -y install terraform
# install latest version of kubectl v 1.27
echo "Setup kubectl"
if [ ! $(which kubectl 2>/dev/null) ]; then
  echo "Install kubectl v1.27.9"
  #curl -LO https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl
  #https://dl.k8s.io/release/v1.24.14/bin/linux/amd64/kubectl
  curl --silent -LO https://dl.k8s.io/release/v1.27.9/bin/linux/amd64/kubectl >/dev/null
  chmod +x ./kubectl
  sudo mv ./kubectl /usr/local/bin/kubectl >/dev/null
  kubectl completion bash >>~/.bash_completion
fi
#
echo "Setup Terraform cache"
if [ ! -f $HOME/.terraform.d/plugin-cache ]; then
  mkdir -p $HOME/.terraform.d/plugin-cache
  cp dot-terraform.rc $HOME/.terraformrc
fi
export ACCOUNT_ID=$(aws sts get-caller-identity --output text --query Account)
export AWS_REGION=$(curl -s 169.254.169.254/latest/dynamic/instance-identity/document | jq -r '.region')
export TF_VAR_region=${AWS_REGION}
test -n "$AWS_REGION" && echo AWS_REGION is "$AWS_REGION" || echo "AWS_REGION is not set !!"
echo "export ACCOUNT_ID=${ACCOUNT_ID}" | tee -a ~/.bash_profile
echo "export AWS_REGION=${AWS_REGION}" | tee -a ~/.bash_profile
echo "export TF_VAR_region=${AWS_REGION}" | tee -a ~/.bash_profile
aws configure set default.region ${AWS_REGION}
aws configure get region

